#!/usr/bin/env python
"""Convert latitude and longtitude bounds to tiles coordinates."""

import argparse

from pyosm.metatile import Metatile
from pyosm.point import str_to_range, Bound, Bounds, LatLongBound
from pyosm.tile import Tile


DEFAULT_BASEDIR = "/var/lib/mod_tile"
DEFAULT_EXT = ".png"
BUFFER_LEN = 1000


class Buffer(object):
    def __init__(self):
        self._buffer = []

    def append(self, i):
        if len(self._buffer) > BUFFER_LEN:
            self._buffer.pop(0)

        self._buffer.append(i)

    def __contains__(self, i):
        return i in self._buffer


def parse_args():
    parser = argparse.ArgumentParser(description=("Convert latitude and longtitude bounds to tiles "
                                                  "coordinates."))
    parser.add_argument("-d", "--basedir", default=DEFAULT_BASEDIR, help="output basedir prefix")
    parser.add_argument("-e", "--ext", default=DEFAULT_EXT, help="output extension")
    parser.add_argument("-m", "--meta", action="store_true", help="convert path to metatile?")
    parser.add_argument("--lng", required=True, type=str, metavar="LNG1[:LNG2]",
                        help="longtitude coordinate (or range LNG1:LNG2)")
    parser.add_argument("--lat", required=True, type=str, metavar="LAT1[:LAT2]",
                        help="latitude coordinate (or range LAT1:LAT2")
    parser.add_argument("--zooms", default="10:10", type=str, metavar="Z1[:Z2]",
                        help="zoom coordinate (or range Z1:Z2)")
    return parser.parse_args()


def main():
    args = parse_args()

    zooms = str_to_range(args.zooms, output=int)
    lat = str_to_range(args.lat)
    lng = str_to_range(args.lng)

    bounds = Bounds(bounds=[])
    for zoom in range(min(zooms), max(zooms) + 1):
        ll_bound = LatLongBound(z=zoom, lat1=lat[0], lat2=lat[1], lng1=lng[0], lng2=lng[1])
        bounds.append(Bound.from_latlong_bound(ll_bound))

    buf = Buffer()

    for point in bounds.points():
        tile = Tile(z=point.z, x=point.x, y=point.y, style="")
        if args.meta:
            metatile = Metatile.from_tile(tile)
            path = metatile.filepath(args.basedir)
            if path in buf:
                continue
            buf.append(path)
        else:
            path = tile.filepath(args.basedir)

        print(path)


if __name__ == "__main__":
    main()
